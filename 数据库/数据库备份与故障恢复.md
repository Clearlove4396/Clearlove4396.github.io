#### 

#### 2 数据库恢复

- 数据库利用“冗余数据”进行恢复；

- 建立冗余数据最常用的技术是**数据转储**和**登记日志文件**。

  ##### 2.1 数据转储

  - 数据库管理员定期地把整个数据库复制到存储介质中保存。这些数据叫**后备副本**。
  - 当数据库遭到破坏时，可以将后备副本重新装入，但是**后备副本只能将数据库恢复到转储时的状态，这时候必须重新运行转储以后的所有更新事务**。

  转储可分为静态转储和动态转储，还可以分为海量转储和增量转储。

  - **静态转储**：在系统中无运行事务时进行的转储操作，在转储期间不允许对数据库进行任何存取、修改。转储的后备副本和转储时的数据库一致。降低了数据库的可用性。
  - **动态转储**：转储期间允许对数据库进行存取或修改，即**转储和用户事务可以并发执行**。转储结束时不能保证后备副本上的数据是正确有效的。因此必须把转储期间各个事务对数据的修改活动登记下来，建立**日志文件**。这样后备副本＋日志文件就可以恢复数据库。
  - **海量转储**：每次都转储全部数据库
  - **增量转储**：每次转储上一次转储后更新过的数据。

![image-20200905223112968](.\pictures\转储分类.png)

	##### 		

	##### 	2.2 登记日志文件

- **遵守的原则**：

  - 登记的次序必须严格按照并发事件执行的时间次序；

  - 必须**先写日志文件，后写数据库**。

    ![image-20200905233955910](.\pictures\问题1.png)

- 有两种格式：以**记录**为单位的日志文件；以数据块为单位的日志文件

  - **以记录为单位的日志文件**登记内容：

    - 各个事务的开始标记；
    - 各个事务的结束标记；
    - 各个事务的所有**更新**操作

  - 每个日志记录的内容包括：

    - 事务标识；
    - 操作类型（插入、删除或修改）
    - 操作对象（记录内部标识）
    - 更新前的旧值
    - 更新后的新值

  - **以数据块为单位的日志文件**：将更新前后的整个数据块都放入日志文件中。

    

  ##### 2.3 恢复策略

2.3.1 **事务故障**（事务在运行至正常终点前被终止）的恢复（利用**undo log**日志，撤销事务操作）

- 反向扫描日志文件（即从最后向前扫描日志文件），查找该事务的更新（更新，插入，删除）操作。
- 对该事务的更新操作执行“逆操作”；
- 如此反复，知道读取到此事务的开始标记，事务故障就恢复完成了。

2.3.2 **系统故障**的恢复

​	系统故障造成的数据库不一致有两种原因：① 未完成事务对数据库的更新可能已写入数据库；② 已提交事务对数据库的更新可能还留在缓冲区没来得及写入数据库。

​	因此需要：**撤销故障发生时未完成的事务，重做已完成的事务**。