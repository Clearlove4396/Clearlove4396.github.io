#### 1 故障分类

1. **事务故障**
   - 即事务没有到达预期的终点（COMMIT或者显式地ROLLBACK）。这时候需要执行**事务撤销（UNDO)**

2. **系统故障**
   - 尚未完成的事务的结果可能已送入物理数据库；需要执行UNDO
   - 已完成的事务可能有一部分或者全部都留在缓冲区中，没有能够写回磁盘中。需要执行REDO
3. **介质故障**
   - 磁盘损坏等



####  2 数据库恢复

- 数据库利用“**冗余数据**”进行恢复；

- 建立冗余数据最常用的技术是**数据转储**和**登记日志文件**。

  ##### 2.1 数据转储

  - 数据库管理员定期地把整个数据库复制到存储介质中保存。这些数据叫**后备副本**。
  - 当数据库遭到破坏时，可以将后备副本重新装入，但是**后备副本只能将数据库恢复到转储时的状态，这时候必须重新运行转储以后的所有更新事务**。

  转储可分为静态转储和动态转储，还可以分为海量转储和增量转储。

  - **静态转储**：在系统中无运行事务时进行的转储操作，在转储期间不允许对数据库进行任何存取、修改。转储的后备副本和转储时的数据库一致。降低了数据库的可用性。
  - **动态转储**：转储期间允许对数据库进行存取或修改，即**转储和用户事务可以并发执行**。转储结束时不能保证后备副本上的数据是正确有效的。因此必须把转储期间各个事务对数据的修改活动登记下来，建立**日志文件**。这样后备副本＋日志文件就可以恢复数据库。
  - **海量转储**：每次都转储全部数据库
  - **增量转储**：每次转储上一次转储后更新过的数据。

![image-20200905223112968](.\pictures\转储分类.png)

##### 2.2 登记日志文件

- **遵守的原则**：

  - 登记的次序必须严格按照并发事件执行的时间次序；

  - 必须**先写日志文件，后写数据库**。

    ![image-20200905233955910](.\pictures\问题1.png)
    
    - 个人理解：因为执行UNDO操作是反向扫描日志文件，并且执行逆操作。假如往数据库中插入一条数据：在写入日志之后，写入数据库之前出错。UNDO时，对“插入”操作实际执行的是“删除“命令，那么因为数据库中本身就没有这一条数据，所以”只不过是多执行一次不必要的UNDO操作“。

- 有两种格式：以**记录**为单位的日志文件；以数据块为单位的日志文件

  - **以记录为单位的日志文件**登记内容：

    - 各个事务的开始标记；
    - 各个事务的结束标记；
    - 各个事务的所有**更新**操作

  - 每个日志记录的内容包括：

    - 事务标识；
    - 操作类型（插入、删除或修改）
    - 操作对象（记录内部标识）
    - 更新前的旧值
    - 更新后的新值

  - **以数据块为单位的日志文件**：将更新前后的整个数据块都放入日志文件中。

    

##### 2.3 恢复策略

2.3.1 **事务故障**（事务在运行至正常终点前被终止）的恢复（利用**undo log**日志，撤销事务操作）

- 反向扫描日志文件（即从最后向前扫描日志文件），查找该事务的更新（更新，插入，删除）操作。
- 对该事务的更新操作执行“逆操作”；
- 如此反复，直到读取到此事务的开始标记，事务故障就恢复完成了。

2.3.2 **系统故障**的恢复

​	系统故障造成的数据库不一致有两种原因：① 未完成事务对数据库的更新可能已写入数据库；② 已提交事务对数据库的更新可能还留在缓冲区没来得及写入数据库。

​	因此需要：**撤销故障发生时未完成的事务，重做已完成的事务**。

- **正向**扫描日志文件（即从头扫描日志文件），找出在故障发生前已经提交的事务（这些事务既有BEGIN TRANSACTON记录，也有COMMIT记录），将其事务标识记入**重做队列**（**REDO-LIST**）。同时找出故障发生时尚未完成的事务（这些事务只有BEGIN TRANSACTION），将其事务标记记入**撤销队列**（**UNDO-LIST**）。
- 对撤销队列中的各个事务进行撤销（UNDO）处理。
  - 进行撤销的方法是，**反向**扫描日志文件，对每个撤销事务的更新操作执行逆操作，即将日志记录中“更新前的值”写入数据库。
- 对重做队列中的各个事务进行重做处理。
  - 进行重做的方法是，**正向**扫描日志文件，对每个重做事务重新执行日志文件登记的操作，即将日志记录中“更新后的值”写入数据库。

2.3.3 **介质故障**恢复

- 恢复方法：重装数据库（使用**后备副本**），然后重做已完成的事务。
  1. 装入最新的数据库后备副本，使数据库恢复到最近一次转储时的一致性状态。对于动态转储的数据库副本，还需要同时装入转储开始时刻的日志文件副本，利用恢复系统故障的方法（REDO + UNDO），才能将数据库恢复到一致性状态。
  2. 装入相应的日志文件副本（转储结束时刻的日志文件副本），重做已完成的事务。这样数据库就可以恢复到故障发生前**某一时刻**的一致状态。



##### 2.4 具有检查点的恢复技术

- 利用日志技术进行数据库恢复的缺点
  - 搜索整个日志文件，耗费大量的时间；
  - 很多需要重做处理的事务实际上已经将它们的更新操作结果写入到了数据库，然而恢复子系统又重新执行了这些操作，浪费了大量的时间。

- 具有检查点的恢复技术

  ![image-20200906094100972](.\pictures\具有检查点的日志我呢间和重新开始文件.png)
  - **检查点记录**的内容：
    - 建立检查点时刻所有**正在执行**的事务清单；
    - 这些事务最近一个日志记录的地址。
  - **重新开始文件**
    - 记录各个检查点记录在日志文件中地址
  - 维护日志文件的方法：
    - 将当前日志缓冲区中的所有日志记录写入到磁盘的日志文件中；
    - 在日志文件中写入一个检查点记录。
    - 将当前数据缓冲区的所有数据记录写入磁盘
    - 将检查点记录在日志文件中的地址写入一个重新开始文件。
  - 系统使用检查点方法进行恢复的步骤：
    - 从重新开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址在日志文件中找到最后一个检查点记录。
    - 由该检查点记录得到检查点建立时刻所有**正在执行**的事务清单ACTIVE-LIST。
    - 把ACTIVE-LIST暂时放入UNDO队列中，REDO队列暂时为空。
    - 从检查点记录开始正向扫描日志文件：① 如果有**新开始**的事务Ti，把Ti暂时放入UNDO队列；② 如果有**提交**的事务Tj，把Tj从UNDO队列移到REDO队列中；直到文件结束。
    - 对UNDO队列中的每个事务执行UNDO操作，对REDO队列中的每个事务执行REDO操作。

![image-20200906143138346](.\pictures\恢复子系统采取的不同策略.png)

​	